# SSD 規格書：國立新化高工午餐三聯式繳費單產生器

| 項目 | 內容 |
|------|------|
| 文件編號 | SSD-LUNCHBILL-001 |
| 版本 | v2.0 |
| 狀態 | Released |
| 最後更新 | 2025-01-31（Asia/Taipei） |
| 專案名稱 | st_lunch_bill_report |
| 開發單位 | 國立新化高工 |
| 審核者 | — |

---

## 修訂歷史

| 版本 | 日期 | 變更摘要 | 作者 |
|------|------|----------|------|
| v1.0 | 2024-01 | 初版建立 | — |
| v1.5 | 2024-01-31 | 新增 §4.3.3 動態 SQL 組建規則、§6.5 預覽模式規範 | — |
| v1.6 | 2024-01-31 | SSD 優化：修正章節編號、新增需求編號、補充修訂歷史 | — |
| v2.0 | 2025-01-31 | 重大更新：<br/>- 更新為 .NET 10 架構<br/>- 新增學年度/學期選擇功能<br/>- 新增報表備註自訂功能<br/>- 更新 UI 設計規範（現代化 WPF UI）<br/>- 更新報表版面規範（A4 三聯式，含虛線切割線）<br/>- 明確定義繳費期限格式轉換規則<br/>- 補充條碼生成實作細節（ZXing.Net）<br/>- 更新欄位映射規範<br/>- 補充資料驗證與錯誤處理流程 | — |

---

## 1. 目的與範圍

### 1.1 目的
建立一套 Windows 桌面應用程式，使用 **Visual Studio 2022 / C# WPF / .NET 10（x64）**，讀取**既有且已包含完整報表資料**的 **Access `.accdb`** 資料庫，並以 **RDLC（Microsoft.Reporting.NETCore）** 產生「**A4、一人一頁、三聯式繳費單**」報表。

本系統專為**國立新化高工學生餐費管理**設計，支援超商代收條碼（Code39 格式），並提供現代化的使用者介面與彈性的報表設定功能。

### 1.2 範圍內
- ✅ 讀取 Access `.accdb` 資料庫的資料表或查詢
- ✅ 支援欄位名稱映射（透過 `fieldmap.json` 設定檔）
- ✅ 產生三聯式繳費單報表（RDLC）
- ✅ 自動生成超商代收條碼圖片（Code39 格式，使用 ZXing.Net）
- ✅ 支援學年度與學期選擇
- ✅ 支援自訂報表備註
- ✅ 繳費期限格式自動轉換（MMDD → YYYMMDD 民國年格式）
- ✅ 輸出功能：
  - 預覽報表（使用系統預設 PDF 閱讀器）
  - 匯出 PDF 檔案
  - 直接列印
- ✅ 完整的處理記錄（Log）與錯誤處理
- ✅ 現代化 WPF UI 設計（卡片式版面、主題配色）

### 1.3 範圍外（本版明確不做）
- ❌ 不從 CSV/Excel 匯入資料
- ❌ 不在程式內進行金額計算或條碼內容計算
- ❌ 不修改或寫入 `.accdb` 的主資料（僅讀取）
- ❌ 不依賴 Microsoft Word/Excel
- ❌ 不支援線上繳費或電子支付整合

---

## 2. 名詞與約定

### 2.1 基本術語
- **三聯式繳費單**：同一張 A4 紙上分為三個區塊（第一聯/第二聯/第三聯），每位學生一頁。三聯之間以虛線分隔，方便裁切。
- **學年度/學期**：民國年學年度（如 114 學年度）與學期別（1 或 2）
- **三段式條碼**：依臺灣超商代收規範的三段 Code39 條碼
- **民國年格式（YYYMMDD）**：民國年 3 碼 + 月日各 2 碼，共 7 碼（如 1140310 表示 114 年 3 月 10 日）

### 2.2 技術術語
- **RDLC**：Report Definition Language Client-side，本地報表處理引擎
- **Code39**：條碼符號規格（symbology），支援數字、大寫英文字母及部分特殊符號
- **ZXing.Net**：開源條碼生成/解析函式庫，用於產生條碼圖片
- **ACE OLEDB Provider**：Microsoft Access Database Engine，用於連接 `.accdb` 資料庫

---

## 3. 技術架構與部署約束

### 3.1 開發環境
| 項目 | 規格 |
|------|------|
| IDE | Visual Studio 2022 |
| 目標框架 | .NET 10.0 |
| 專案類型 | WPF Application (x64) |
| 程式語言 | C# 12.0 |
| UI 框架 | WPF (Windows Presentation Foundation) |

### 3.2 執行環境需求
| 項目 | 需求 |
|------|------|
| 作業系統 | Windows 10 (1809+) / Windows 11 |
| 架構 | x64 (64-bit) |
| .NET Runtime | .NET 10.0 Runtime (Desktop) |
| 資料庫引擎 | Microsoft Access Database Engine 2016 (x64) |
| PDF 閱讀器 | Adobe Acrobat Reader 或相容程式 |

### 3.3 核心 NuGet 套件
| 套件名稱 | 版本 | 用途 |
|----------|------|------|
| Microsoft.Reporting.NETCore | 1.1.0+ | RDLC 報表引擎 |
| System.Data.OleDb | 8.0.0+ | Access 資料庫連接 |
| ZXing.Net | 0.16.9+ | 條碼圖片生成 |
| ZXing.Net.Bindings.Windows.Compatibility | 0.16.12+ | Windows 平台相容性 |

### 3.4 專案結構
```
st_lunch_bill_report/
├── MainWindow.xaml          # 主視窗 UI
├── MainWindow.xaml.cs       # 主視窗邏輯
├── App.xaml                 # 應用程式設定
├── Services/
│   ├── DatabaseService.cs   # 資料庫存取服務
│   └── ReportService.cs     # 報表產生服務
├── Reports/
│   └── LunchBill3Part.rdlc  # RDLC 報表定義
├── fieldmap.json            # 欄位對應設定（可選）
├── README.md                # 專案說明文件
└── spec.md                  # 本規格書
```

---

## 4. 資料來源需求（Access `.accdb`）

### 4.1 資料庫連接
- **連接字串格式**：
  ```
  Provider=Microsoft.ACE.OLEDB.12.0;Data Source={databasePath};Persist Security Info=False;
  ```
- **支援的資料來源**：
  - 資料表（Tables）
  - 查詢（Queries/Views）
- **讀取順序**：建議按 `班級`、`座號`、`學號` 排序

### 4.2 標準欄位定義（Canonical Fields）

以下為 RDLC 報表使用的標準欄位名稱。Access 資料庫欄位可透過 `fieldmap.json` 進行映射。

#### 4.2.1 學生基本資訊
| 標準欄位名 | 資料型別 | 必填 | 說明 | 預設對應 |
|-----------|---------|------|------|---------|
| ClassName | String | ✓ | 班級名稱 | 班級 |
| ParentName | String | ✓ | 學生或家長姓名 | 姓名 |
| StudentId | String | ✓ | 學號（6碼） | 學號 |
| SeatNumber | String/Int | ✓ | 座號 | 座號 |

#### 4.2.2 費用明細
| 標準欄位名 | 資料型別 | 必填 | 說明 | 預設對應 |
|-----------|---------|------|------|---------|
| LunchFee | Int | ✓ | 學期午餐費用 | 學期午餐費用 |
| FreshMilkFee | Int |  | 新生訓練餐費 | 新生訓練餐費 |
| SchoolMealFee | Int |  | 暑期輔導餐費 | 暑期輔導餐費 |
| AfterSchoolFee | Int |  | 退前一學期餐費 | 退前一學期餐費 |
| AgencyFee | Int |  | 超商代收手續費 | 超商代收手續費 |
| TotalFee | Int | ✓ | 應繳金額 | 應繳金額 |
| TotalFeeAlt | Int | ✓ | 實繳金額 | 應繳金額 |
| FeeDetails | String | ✓ | 金額中文大寫 | 應繳金額國字 |

#### 4.2.3 繳費資訊
| 標準欄位名 | 資料型別 | 必填 | 說明 | 預設對應 |
|-----------|---------|------|------|---------|
| ParentNote | String/DateTime | ✓ | 繳費期限 | 繳費期限 |
| ContactInfo | String | ✓ | 銷帳編號 | 銷帳編號 |

#### 4.2.4 條碼資訊
| 標準欄位名 | 資料型別 | 必填 | 說明 | 預設對應 |
|-----------|---------|------|------|---------|
| Barcode1 | String | ✓ | 第一段條碼（9碼） | 條碼1序號碼 |
| Barcode2 | String | ✓ | 第二段條碼（16碼） | 條碼2序號碼 |
| Barcode3 | String | ✓ | 第三段條碼（15碼） | 條碼3序號碼 |

### 4.3 欄位映射機制

#### 4.3.1 映射設定檔（fieldmap.json）
程式支援透過 `fieldmap.json` 設定檔自訂欄位映射，範例格式：

```json
{
  "ClassName": "班級",
  "ParentName": "姓名",
  "StudentId": "學號",
  "SeatNumber": "座號",
  "LunchFee": "學期午餐費用",
  "FreshMilkFee": "新生訓練餐費",
  "SchoolMealFee": "暑期輔導餐費",
  "AfterSchoolFee": "退前一學期餐費",
  "AgencyFee": "超商代收手續費",
  "TotalFee": "應繳金額",
  "TotalFeeAlt": "應繳金額",
  "FeeDetails": "應繳金額國字",
  "ParentNote": "繳費期限",
  "ContactInfo": "銷帳編號",
  "Barcode1": "條碼1序號碼",
  "Barcode2": "條碼2序號碼",
  "Barcode3": "條碼3序號碼"
}
```

#### 4.3.2 動態 SQL 組建
程式根據映射設定動態生成 SQL 查詢，使用 `AS` 別名將資料庫欄位名轉換為標準欄位名：

```sql
SELECT
  [班級] AS [ClassName],
  [姓名] AS [ParentName],
  [學號] AS [StudentId],
  [座號] AS [SeatNumber],
  [學期午餐費用] AS [LunchFee],
  [條碼1序號碼] AS [Barcode1],
  [條碼2序號碼] AS [Barcode2],
  [條碼3序號碼] AS [Barcode3],
  ...
FROM [資料來源]
ORDER BY [班級], [座號], [學號]
```

#### 4.3.3 映射規則
1. 若資料庫欄位名與標準欄位名相同，則不需加 `AS`
2. 所有欄位名使用方括號 `[]` 包裹，避免保留字衝突
3. 若映射設定有誤（欄位不存在），程式會記錄錯誤並終止執行

### 4.4 繳費期限格式處理

#### 4.4.1 自動格式轉換規則
程式會自動將繳費期限轉換為 `YYYMMDD` 格式（民國年月日）：

| 來源格式 | 轉換規則 | 範例 |
|---------|---------|------|
| DateTime | 計算民國年（西元年 - 1911）+ 格式化為 MMDD | 2025-03-10 → 1140310 |
| MMDD（4碼字串） | 使用當前民國年 + 原字串 | 0310 → 1140310（當年為 114年）|
| 其他格式 | 保持原值 | 1140310 → 1140310 |

#### 4.4.2 民國年計算邏輯
```csharp
var rocYear = DateTime.Now.Year - 1911;
```

---
本 SSD 以「**報表欄位名稱**」作為 RDLC 的**標準欄位名（Canonical Fields）**。  
若 `.accdb` 實際欄位名不同，程式必須提供映射（Mapping）以在載入後建立同名 `DataTable` 欄位供 RDLC 使用。

#### 4.3.1 標準欄位名（RDLC 使用）與建議對應
| RDLC 標準欄位名 | 建議對應的 `.accdb` 欄位名 | 備註 |
|---|---|---|
| 科班別 | 班級 |  |
| 繳款人 | 姓名 |  |
| 學號 | 學號 | 固定 6 碼（資料庫端已確保） |
| 座號 | 座號 |  |
| 學期午餐費用 | 學期午餐金額 |  |
| 新生訓練餐費 | 新生訓練午餐費 |  |
| 暑期輔導餐費 | 暑期輔導午餐費 |  |
| 退前一學期餐費 | 退前一學期午餐費 |  |
| 超商代收費 | 超商代收手續費 |  |
| 應繳金額 | 應繳金額 |  |
| 金額 | 實繳金額 | 報表顯示欄名為「金額」 |
| 實繳金額中文 | 實繳金額中文 |  |
| 繳費期限 | 繳費截止日 / 繳費期限 | 依你 `.accdb` 實際欄位為準 |
| 銷帳編號 | 原始銷帳編號 / 銷帳編號 | 依你 `.accdb` 實際欄位為準 |
| 第1段條碼 | 第1段條碼 | RDLC 顯示使用條碼圖片欄位（見 §5.3）；不在 RDLC 內以字型產生 |
| 第2段條碼 | 第2段條碼 | 同上 |
| 第3段條碼 | 第3段條碼 | 同上 |

#### 4.3.2 映射提供方式
- **選配** `fieldmap.json`：部署時允許以設定檔調整欄位名（避免重新編譯）。
- **或** 程式內常數映射：需可維護版本並清楚記錄變更。

> 不論使用哪種方式，程式不得對欄位內容做演算法重算；僅允許「欄位名對應」與「字串/數值格式化（顯示）」。

#### 4.3.3 動態 SQL 組建規則（確保 DataTable 欄位名一致）
程式需依據映射設定檔（或內建映射常數）**動態組建 SELECT 語法**，使用 `AS` 別名將 Access 實際欄位名轉換為 RDLC 標準欄位名。

**範例**：若 `fieldmap.json` 定義如下映射：
```json
{
  "科班別": "班級",
  "繳款人": "姓名",
  "學期午餐費用": "學期午餐金額",
  "金額": "實繳金額"
}
```

則程式應產生類似以下 SQL：
```sql
SELECT
  [班級] AS [科班別],
  [姓名] AS [繳款人],
  [學號],
  [座號],
  [學期午餐金額] AS [學期午餐費用],
  [實繳金額] AS [金額],
  ...
FROM [報表資料來源]
ORDER BY [班級], [座號], [學號]
```

**實作要點**：
1. 若 Access 欄位名與 RDLC 標準欄位名相同，則不需加 `AS`（如 `[學號]`）。
2. 所有欄位名需以方括號 `[]` 包裹，避免保留字或特殊字元問題。
3. 動態 SQL 組建後，讀入的 `DataTable.Columns` 名稱必須完全符合 RDLC DataSet 定義。
4. 若映射設定有誤（如 Access 無該欄位），於執行查詢時會拋出例外，程式需捕捉並於 Log 顯示明確錯誤訊息。


---

## 5. 報表輸出（RDLC）

### 5.1 頁面規格
| 項目 | 規格 |
|------|------|
| 紙張大小 | A4 (21cm × 29.7cm) |
| 頁面方向 | 直向（Portrait） |
| 邊界 | 上下左右各 1cm |
| 內容寬度 | 19cm |
| 內容高度 | 27.7cm |
| 分頁規則 | 一人一頁（每筆資料強制換頁） |

### 5.2 三聯式版面配置

#### 5.2.1 整體結構
```
┌─────────────────────────────────────┐ ← 頁首 (0cm)
│  第一聯：學校存根聯 (8.6cm)          │
├─────────────────────────────────────┤ ← 8.6cm
│  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─  │ ← 虛線切割線 (8.85cm)
├─────────────────────────────────────┤ ← 9.1cm
│  第二聯：繳費人存根聯 (8.6cm)        │
├─────────────────────────────────────┤ ← 17.7cm
│  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─  │ ← 虛線切割線 (17.95cm)
├─────────────────────────────────────┤ ← 18.2cm
│  第三聯：超商繳款聯 (9.4cm)          │
└─────────────────────────────────────┘ ← 27.6cm
```

#### 5.2.2 各聯規格
| 聯別 | 起始位置 | 寬度 | 高度 | 用途 |
|------|---------|------|------|------|
| 第一聯 | 0cm | 19cm | 8.6cm | 學校存根聯（含費用明細表） |
| 第二聯 | 9.1cm | 19cm | 8.6cm | 繳費人存根聯（含三段條碼橫排） |
| 第三聯 | 18.2cm | 19cm | 9.4cm | 超商繳款聯（含三段條碼橫排） |

#### 5.2.3 間距與切割線
- **間距**：各聯之間間隔 0.5cm (5mm)
- **切割線**：
  - 第一與第二聯之間：虛線位於 8.85cm（間距中央）
  - 第二與第三聯之間：虛線位於 17.95cm（間距中央）
  - 線條樣式：Dashed, 1pt, 黑色

### 5.3 報表內容元素

#### 5.3.1 第一聯：學校存根聯
**標題**
- 文字：「國立新化高工學生餐費 繳費通知單（學校存根聯）」
- 字體：14pt, 粗體, 置中

**學生資訊**
- 班級、座號、姓名、學號（橫向排列）
- 字體：10pt

**費用明細表**
- 5行2列的表格：
  - 學期午餐費用 / 新生訓練餐費
  - 暑期輔導餐費 / 退前一學期餐費
  - 超商代收手續費 / **應繳金額**（灰底粗體）
- 數字欄位：右對齊, 千分位格式 (N0)

**繳費資訊**
- 實繳金額（含中文大寫）
- 繳費期限、銷帳編號

**條碼區域**（右側）
- 三段條碼垂直排列
- 每段條碼尺寸：6.8cm × 1cm
- 條碼間距：0.1cm

**備註區**
- 固定文字：「備註：請於繳費期限內至超商繳費」

#### 5.3.2 第二聯：繳費人存根聯
**標題**
- 文字：「國立新化高工學生餐費 繳費通知單（繳費人存根聯）」
- 字體：14pt, 粗體, 置中

**學生資訊**
- 班級、座號、姓名、學號
- 實繳金額、繳費期限、銷帳編號

**條碼區域**（橫向排列）
- 三段條碼並排
- 每段條碼：
  - 圖片：6cm × 1cm
  - 文字：8pt, Consolas, 置中對齊

**備註區**
- 文字：使用 UI 輸入的自訂備註（`ReportNote` 欄位）
- 預設：「備註：請於繳費期限內至超商繳費」

#### 5.3.3 第三聯：超商繳款聯
**標題**
- 文字：「國立新化高工學生餐費 超商繳款聯」
- 字體：14pt, 粗體, 置中

**繳費資訊**
- 繳款人、班級、學號
- 應繳金額（12pt 粗體）+ 中文大寫
- 繳費期限、銷帳編號

**條碼區域**
- 標題：【超商繳費條碼】（10pt 粗體, 置中）
- 三段條碼並排：
  - 每段條碼：6cm × 1.2cm
  - 文字：9pt, Consolas, 置中對齊
- 說明文字：「可至第一銀行或代收超商(僅限7-ELEVEN、全家、萊爾富) 繳費」

**頁尾**
- 文字：「※ 本聯由銀行或超商收執 ※ 請妥善保管繳費收據作為繳費證明」
- 字體：9pt, 置中

### 5.4 條碼顯示規則

#### 5.4.1 條碼產生技術
- **使用函式庫**：ZXing.Net (v0.16.9+)
- **條碼格式**：Code39
- **輸出格式**：PNG 圖片（byte[]）
- **RDLC 欄位**：
  - `Barcode1_Img` (byte[])
  - `Barcode2_Img` (byte[])
  - `Barcode3_Img` (byte[])

#### 5.4.2 條碼生成參數
```csharp
var writer = new BarcodeWriterPixelData
{
    Format = BarcodeFormat.CODE_39,
    Options = new EncodingOptions
    {
        Height = 50,      // 條碼高度（像素）
        Width = 300,      // 條碼寬度（像素）
        Margin = 10,      // Quiet Zone
        PureBarcode = false  // 顯示人類可讀碼
    }
};
```

#### 5.4.3 Code39 起訖字元處理
- ZXing.Net **自動加上起訖 `*` 字元**
- 程式**不需手動**在條碼內容前後加 `*`
- 輸入：`123456789` → 輸出圖片內含：`*123456789*`

#### 5.4.4 條碼品質要求
- ✅ 黑條白底，無灰階漸層
- ✅ 邊界清晰，無模糊
- ✅ Quiet Zone（左右留白）至少 10 像素
- ✅ 可被超商掃描器正常讀取

### 5.5 RDLC DataSet 定義

#### 5.5.1 原始資料欄位（來自資料庫）
共 17 個欄位，詳見 §4.2

#### 5.5.2 程式產生欄位
| 欄位名稱 | 型別 | 產生時機 | 說明 |
|---------|------|---------|------|
| Barcode1_Img | byte[] | 載入資料後 | 第一段條碼圖片 |
| Barcode2_Img | byte[] | 載入資料後 | 第二段條碼圖片 |
| Barcode3_Img | byte[] | 載入資料後 | 第三段條碼圖片 |
| ReportNote | String | 載入資料後 | 使用者自訂備註（來自 UI） |

#### 5.5.3 最終 DataSet 欄位清單
共 **21 個欄位**：17 個原始欄位 + 3 個條碼圖片 + 1 個自訂備註

---

## 6. UI 規格（現代化 WPF UI）

### 6.1 設計原則
- ✨ **現代化設計**：卡片式版面、圓角邊框、陰影效果
- 🎨 **主題配色**：藍灰色系，專業且清新
- 📱 **清晰分組**：功能區塊明確，使用 Emoji 圖示
- ♿ **易用性**：直覺的操作流程，明確的狀態提示

### 6.2 主題配色方案
| 用途 | 色碼 | 說明 |
|------|------|------|
| 主色 (Primary) | #2563EB | 藍色（主按鈕、聚焦邊框） |
| 成功色 (Success) | #059669 | 綠色（匯出 PDF 按鈕） |
| 危險色 (Danger) | #DC2626 | 紅色（結束程式按鈕） |
| 次要色 (Secondary) | #64748B | 灰藍（次要按鈕、輔助文字） |
| 背景色 | #F0F4F8 | 淺灰藍（視窗背景） |
| 卡片背景 | #FFFFFF | 白色（GroupBox 背景） |
| 邊框色 | #E2E8F0 | 淺灰（卡片邊框） |
| 輸入框背景 | #F8FAFC | 極淺灰（輸入框背景） |
| 文字主色 | #1E293B | 深灰（標題、內容） |
| 文字次色 | #64748B | 灰色（說明文字） |

### 6.3 視窗規格
| 項目 | 規格 |
|------|------|
| 視窗大小 | 960 × 720 像素 |
| 啟動位置 | 螢幕中央 |
| 視窗標題 | 「國立新化高工午餐三聯式繳費單系統」 |
| 背景色 | #F0F4F8 |
| 內邊距 | 20px |

### 6.4 UI 元件配置

#### 6.4.1 標題區塊
- **主標題**：「🍱 國立新化高工午餐三聯式繳費單」
  - 字體：24pt, 粗體
  - 顏色：#1E293B
- **副標題**：「國立新化高工學生餐費繳費單系統」
  - 字體：13pt
  - 顏色：#64748B

#### 6.4.2 資料庫設定區塊（📁）
**資料庫選擇**
- 【選擇資料庫...】按鈕（次要按鈕樣式, 110px）
- 資料庫路徑文字框（唯讀, 淺灰背景）
- 【複製】按鈕（次要按鈕樣式, 60px）

**資料來源**
- 標籤：「資料來源：」
- 下拉選單（ComboBox）：列出資料表/查詢
  - 預設禁用，選擇資料庫後啟用

**學年度 / 學期**（右側藍色卡片）
- 背景色：#EFF6FF（淺藍）
- 邊框色：#BFDBFE（藍色）
- 學年度：下拉選單（114-124）
- 學期：下拉選單（1, 2）
- 字體：15pt, 粗體

#### 6.4.3 匯出設定區塊（📤）
- 【匯出資料夾...】按鈕（次要按鈕樣式, 110px）
- 匯出路徑文字框（唯讀）
- 【複製】按鈕（次要按鈕樣式, 60px）

#### 6.4.4 報表備註區塊（📝）
- 標籤：「備註說明：」
- 多行文字框（TextBox）：
  - 高度：70px
  - 支援換行（AcceptsReturn）
  - 垂直捲軸（Auto）
  - 預設文字：「備註：請於繳費期限內至超商繳費」

#### 6.4.5 動作按鈕區塊（⚡）
橫向排列，置中對齊，按鈕寬度均為 120px：

| 按鈕 | 樣式 | 圖示 | 事件 |
|------|------|------|------|
| 預覽 | 次要 | 👁 | BtnPreview_Click |
| 匯出 PDF | 成功 | 📄 | BtnExportPdf_Click |
| 列印 | 主要 | 🖨 | BtnPrint_Click |
| 結束程式 | 危險 | ✕ | BtnExit_Click |

#### 6.4.6 處理記錄區塊（📋）
- 多行文字框（唯讀）
- 背景色：#1E293B（深灰）
- 文字色：#E2E8F0（淺灰）
- 字體：Consolas, 12pt
- 捲軸：垂直+水平（Auto）
- 自動捲動到最新記錄

#### 6.4.7 狀態列
卡片式設計（白色背景，圓角邊框）：
- **左側**：狀態指示燈（8px 圓點, 綠色） + 狀態文字
  - 預設：「就緒」
  - 顏色：#1E293B
- **右側**：資料筆數
  - 格式：「資料筆數：0」
  - 顏色：#64748B

### 6.5 按鈕樣式定義

#### 6.5.1 主按鈕（PrimaryButton）
- 背景色：#2563EB（藍色）
- 文字色：白色
- 圓角：6px
- 內邊距：16px × 10px
- 懸停效果：#1D4ED8（深藍）
- 禁用狀態：#CBD5E1（淺灰）

#### 6.5.2 次要按鈕（SecondaryButton）
- 背景色：白色
- 文字色：#1E293B
- 邊框：1px, #E2E8F0
- 圓角：6px
- 懸停效果：#F1F5F9（淺灰）

#### 6.5.3 成功按鈕（SuccessButton）
- 背景色：#059669（綠色）
- 文字色：白色
- 懸停效果：#047857（深綠）

#### 6.5.4 危險按鈕（DangerButton）
- 背景色：#DC2626（紅色）
- 文字色：白色
- 懸停效果：#B91C1C（深紅）

### 6.6 使用者操作流程

#### 6.6.1 基本流程
```
1. 啟動程式
   ↓
2. 選擇資料庫檔案（.accdb）
   ↓
3. 系統自動載入資料來源清單
   ↓
4. 選擇資料來源（Table/Query）
   ↓
5. 系統載入並驗證資料
   ↓
6. （可選）調整學年度/學期
   ↓
7. （可選）調整報表備註
   ↓
8. （可選）設定匯出資料夾
   ↓
9. 執行操作：
   - 預覽：產生暫存 PDF 並開啟
   - 匯出 PDF：儲存到指定資料夾
   - 列印：傳送到印表機
```

#### 6.6.2 學年度/學期自動判斷
程式會根據當前日期自動設定學年度與學期：

| 當前月份 | 學年度 | 學期 |
|---------|--------|------|
| 2-7月 | 前一年 | 第2學期 |
| 8-12月 | 當年 | 第1學期 |
| 1月 | 前一年 | 第1學期 |

**範例**：
- 2025 年 1 月 → 113 學年度第 1 學期
- 2025 年 8 月 → 114 學年度第 1 學期
- 2026 年 3 月 → 114 學年度第 2 學期

### 6.7 功能使用案例（Use Cases）

#### [UC-001] 選擇資料庫
**前置條件**：無  
**主要流程**：
1. 使用者點擊【選擇資料庫...】按鈕
2. 系統開啟檔案選擇對話框（僅顯示 *.accdb 檔案）
3. 使用者選擇資料庫檔案
4. 系統顯示檔案路徑
5. 系統載入資料來源清單
6. 資料來源下拉選單啟用

**替代流程**：
- 3a. 使用者取消選擇 → 回到步驟 1

#### [UC-002] 載入資料
**前置條件**：已選擇資料庫  
**主要流程**：
1. 使用者從資料來源下拉選單選擇 Table/Query
2. 系統顯示「正在載入資料...」
3. 系統讀取資料並驗證欄位
4. 系統產生條碼圖片
5. 系統加入自訂備註欄位
6. 系統更新狀態：「已載入 N 筆資料」
7. 啟用【預覽】、【匯出 PDF】、【列印】按鈕

**替代流程**：
- 3a. 資料驗證失敗 → 顯示錯誤訊息，詢問是否繼續
  - 3a1. 使用者選擇「否」→ 清除資料，回到步驟 1
  - 3a2. 使用者選擇「是」→ 繼續載入（略過錯誤筆）

#### [UC-003] 預覽報表
**前置條件**：已載入資料  
**主要流程**：
1. 使用者點擊【👁 預覽】按鈕
2. 系統產生暫存 PDF（檔名：`LunchBill_Preview_YYYYMMDD_HHMMSS.pdf`）
3. 系統使用預設 PDF 閱讀器開啟檔案
4. Log 記錄：預覽開始、檔案路徑、開啟成功

**替代流程**：
- 3a. PDF 產生失敗 → 顯示錯誤訊息，Log 記錄錯誤
- 4a. 無法開啟 PDF → 顯示錯誤訊息（請安裝 PDF 閱讀器）

#### [UC-004] 匯出 PDF
**前置條件**：已載入資料、已設定匯出資料夾  
**主要流程**：
1. 使用者點擊【📄 匯出 PDF】按鈕
2. 系統產生 PDF（檔名：`LunchBill_YYYYMMDD_HHMMSS.pdf`）
3. 系統儲存到指定資料夾
4. 顯示成功訊息
5. Log 記錄：匯出開始、檔案路徑、筆數、完成時間

**替代流程**：
- 1a. 未設定匯出資料夾 → 提示使用者設定
- 3a. 檔案寫入失敗 → 顯示錯誤訊息（檢查權限/磁碟空間）

#### [UC-005] 列印報表
**前置條件**：已載入資料  
**主要流程**：
1. 使用者點擊【🖨 列印】按鈕
2. 系統產生暫存 PDF
3. 系統開啟列印對話框（使用預設 PDF 閱讀器的列印功能）
4. 使用者選擇印表機與設定
5. 執行列印
6. Log 記錄：列印開始、筆數

**替代流程**：
- 3a. 無法啟動列印 → 嘗試直接開啟 PDF，由使用者手動列印
- 5a. 使用者取消列印 → 關閉對話框

### 6.8 例外處理與錯誤訊息

#### 6.8.1 資料庫連接錯誤
**錯誤情境**：
- 資料庫檔案不存在
- 無法開啟資料庫（檔案損壞、權限不足）
- 缺少 ACE OLEDB Provider (x64)

**處理方式**：
- 顯示錯誤訊息對話框
- Log 記錄完整錯誤資訊
- 提供解決建議：
  - 檢查檔案路徑
  - 確認檔案未被其他程式開啟
  - 安裝 Microsoft Access Database Engine 2016 (x64)

#### 6.8.2 資料驗證錯誤
**錯誤情境**：
- 缺少必要欄位
- 資料型別不符
- 條碼欄位為空或含非法字元

**處理方式**：
- 顯示驗證錯誤清單（含筆數與詳細資訊）
- 詢問使用者：
  - 【取消】：不載入資料
  - 【繼續】：略過錯誤筆，僅載入正常資料
- Log 記錄所有驗證錯誤

#### 6.8.3 條碼生成錯誤
**錯誤情境**：
- 條碼內容含非法字元
- 圖片生成失敗

**處理方式**：
- 顯示錯誤訊息：「條碼生成失敗：第 N 筆資料」
- Log 記錄：條碼內容、錯誤原因
- 該筆資料標記為異常，不列入報表

#### 6.8.4 檔案操作錯誤
**錯誤情境**：
- 匯出資料夾不存在或無寫入權限
- 磁碟空間不足
- 檔案名稱衝突

**處理方式**：
- 顯示錯誤訊息與解決建議
- Log 記錄完整錯誤資訊
- 對於檔案名稱衝突，提供覆寫選項

### 6.9 記錄（Log）規範

#### 6.9.1 Log 格式
```
YYYY-MM-DD HH:mm:ss.fff [LEVEL] message
```

**範例**：
```
2025-01-31 14:30:25.123 [INFO] 應用程式啟動
2025-01-31 14:30:32.456 [INFO] 已選擇資料庫：C:\Data\lunch.accdb
2025-01-31 14:30:35.789 [INFO] 已載入 150 筆資料
2025-01-31 14:30:45.012 [ERROR] 條碼生成失敗：第 23 筆資料
```

#### 6.9.2 Log 等級
| 等級 | 用途 | 範例 |
|------|------|------|
| INFO | 正常操作 | 啟動、載入資料、完成匯出 |
| WARN | 警告訊息 | 資料驗證警告、略過錯誤筆 |
| ERROR | 錯誤 | 資料庫連接失敗、檔案寫入失敗 |

#### 6.9.3 重要事件 Log
- ✅ 應用程式啟動/關閉
- ✅ 資料庫選擇與連接
- ✅ 資料載入開始/完成（含筆數）
- ✅ 資料驗證結果（成功/失敗筆數）
- ✅ 條碼生成結果
- ✅ 預覽/匯出/列印操作（開始/完成）
- ✅ 所有錯誤與例外

### 6.10 程式關閉與資源釋放

#### 6.10.1 正常關閉流程
1. 使用者點擊【✕ 結束程式】按鈕或視窗關閉按鈕
2. 系統停止進行中的操作（若有）
3. 釋放報表物件（LocalReport, DataSource）
4. 關閉資料庫連接（OleDbConnection.Dispose()）
5. 清理暫存檔案
6. 寫入 Log：「應用程式關閉」
7. 呼叫 `Application.Current.Shutdown()`

#### 6.10.2 暫存檔案清理
- **預覽檔案**：`LunchBill_Preview_*.pdf`
- **清理時機**：程式關閉時
- **清理位置**：`Path.GetTempPath()` 目錄

---
6. **抗鋸齒**：避免因抗鋸齒導致邊界模糊。若函式庫可關閉 anti-aliasing 或提供 crisp mode，應啟用。
7. **最大長度限制**：單段條碼印出後長度不得超過 **6.2 cm**（以樣版/作業規範為準）。若版面造成超過，需調整 RDLC 版面或條碼模組寬度（X-dimension）。

### 9.3 三段條碼在樣版中的排版要求（與樣版一致）[REQ-BC-003]
1. 三段條碼由上而下排列。
2. 垂直間距：各段間距至少 **0.6 cm**（以樣版為準）。
3. 條碼區需搭配識別文字（例如「統一超商專用條碼區」）。若樣版含此文字，RDLC 需保留。

### 9.4 驗收標準（掃描可用性）[REQ-BC-004]
1. **螢幕預覽**：輸出 PDF 在 100% 縮放下條碼邊緣清晰、無糊邊、無斷線。
2. **列印測試（必做）**：使用實際將採用的印表機、紙張與列印設定列印 A4 成品。
3. **掃描成功率**：以超商讀碼設備/同等規格掃描器測試，三段條碼皆能在合理時間內成功讀取（建議目標：每段 < 1 秒、成功率 ≥ 99%）。  
4. **異常可追溯**：若任一段條碼生成失敗或掃描不穩定，Log 必須能定位（包含：該筆關鍵欄位、段別、字元集合檢核結果、影像尺寸/DPI 參數）。




## 10. 輸出與檔案命名

### 10.1 PDF 匯出 [REQ-OUT-001]
- 預設輸出格式：PDF（建議）
- 檔名建議：`LunchBill_{yyyyMMdd_HHmmss}.pdf` 或 `LunchBill_{批次識別}.pdf`
- 路徑：使用者可選；預設同 `.accdb` 目錄或使用者文件夾

### 10.2 列印 [REQ-OUT-002]
- 支援系統印表機選擇
- 列印前建議提供預覽

---

## 11. 非功能性需求（NFR）

1. **一致性** [REQ-NFR-001]：同一筆資料在不同電腦輸出版面一致（RDLC 固定版面）
2. **可部署性** [REQ-NFR-002]：僅需部署 EXE + RDLC + 既有 `.accdb`（條碼函式庫以 NuGet 併入程式；不需安裝條碼字型）
3. **效能** [REQ-NFR-003]：1,000 筆資料匯出 PDF 於可接受時間內完成（依硬體訂 KPI）
4. **可靠性** [REQ-NFR-004]：任何錯誤必須回報明確原因（缺欄、連線失敗、條碼圖片生成失敗、列印/匯出失敗）
5. **可追溯性**（選配）[REQ-NFR-005]：可在 `.accdb` 寫入「列印紀錄」（時間、操作者、輸出檔名）

---

## 12. 驗收測試（AT）

### 12.1 版面驗收 [AT-001]
- 以 `3聯式繳費單樣版.pdf` 為對照，檢查：
  - 三聯位置、框線、虛線、標題/欄位對齊
  - 第三聯條碼區位置與大小符合樣版視覺
  - 一人一頁，不得跨頁、不漏頁

### 12.2 條碼可讀性驗收 [AT-002]
- 用至少 2 款超商常見條碼掃描器/App 測試（三段條碼皆可讀）
- 測試列印件（紙本）與 PDF 於不同電腦開啟的可讀性

### 12.3 資料一致性驗收 [AT-003]
- 報表上的每個欄位值必須與 `.accdb` 原始欄位一致（不做演算法重算）
- 條碼顯示字串必須為 `*{DB欄位}*`

---

## 13. 交付物清單

| 編號 | 交付物 | 備註 |
|------|--------|------|
| D-001 | WPF 程式（x64） | 執行檔 + 相依 DLL |
| D-002 | RDLC 報表檔 | `LunchBill3Part.rdlc`（名稱可調整） |
| D-003 | 部署指引 | 含 ACE Provider 64-bit 檢查、條碼函式庫授權/版本資訊 |
| D-004 | 欄位映射設定檔（選配） | `fieldmap.json` |

---

## 附錄 A. 相關文件索引

| 文件名稱 | 說明 | 位置 |
|----------|------|------|
| `3聯式繳費單樣版.pdf` | 繳費單版面參考樣版 | 專案根目錄 |
| `fieldmap.json` | 欄位名稱映射設定（選配） | 執行檔同目錄 |
| `LunchBill3Part.rdlc` | RDLC 報表版型檔 | 執行檔同目錄 |

---

## 附錄 B. 需求追溯矩陣（RTM）索引

| 需求編號 | 章節 | 驗收測試 |
|----------|------|----------|
| UC-001 ~ UC-007 | §6.2 | AT-001, AT-003 |
| REQ-VAL-001 ~ REQ-VAL-003 | §8 | AT-003 |
| REQ-BC-001 ~ REQ-BC-004 | §9 | AT-002 |
| REQ-OUT-001, REQ-OUT-002 | §10 | AT-001 |
| REQ-NFR-001 ~ REQ-NFR-005 | §11 | 全數 |

---
